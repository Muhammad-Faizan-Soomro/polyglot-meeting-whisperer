<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Polyglot Whisperer</title>
    <link rel="icon" href="data:,">
    <style>
        body {
            font-family: sans-serif;
            text-align: center;
            margin-top: 100px;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            margin: 20px;
        }
    </style>
</head>

<body>
    <h1>🎙️ Polyglot Meeting Whisperer</h1>
    <button id="start">Start Recording</button>
    <button id="stop" disabled>Stop Recording</button>

    <script>
        let socket;
        let isRecording = false;
        let stream;
        let interval;

        window.onload = async () => {
            socket = new WebSocket("ws://localhost:8765");

            socket.onopen = () => {
                console.log("✅ WebSocket connected.");
            };

            socket.onclose = (event) => {
                console.log(`❌ WebSocket disconnected. Code: ${event.code}, Reason: ${event.reason}`);
            };

            socket.onerror = (err) => {
                console.error("❌ WebSocket error:", err);
            };
        };

        async function recordChunk() {
            const recorder = new MediaRecorder(stream, { mimeType: "audio/webm;codecs=opus" });

            recorder.ondataavailable = (event) => {
                if (event.data.size > 0 && socket.readyState === WebSocket.OPEN) {
                    socket.send(event.data);
                    console.log("📤 Sent valid audio chunk:", event.data.size);
                }
            };

            recorder.start();
            setTimeout(() => {
                recorder.stop();
            }, 5000); // force stop after 5s to finalize chunk
        }

        document.getElementById("start").onclick = async () => {
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                alert("WebSocket not connected!");
                return;
            }

            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            isRecording = true;

            document.getElementById("start").disabled = true;
            document.getElementById("stop").disabled = false;

            console.log("🔴 Recording started...");

            // Repeat every 5 seconds
            recordChunk();
            interval = setInterval(() => {
                if (isRecording) {
                    recordChunk();
                }
            }, 5000);
        };

        document.getElementById("stop").onclick = () => {
            isRecording = false;
            clearInterval(interval);
            document.getElementById("start").disabled = false;
            document.getElementById("stop").disabled = true;
            console.log("🛑 Recording stopped.");
        };

    </script>
</body>
</html>